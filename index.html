<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Untuk Kamu ‚ù§Ô∏è</title>
  <style>
    /* ==========================================
       STYLING DASAR & UI KACA (GLASSMORPHISM)
       ========================================== */
    body, html { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      overflow: hidden; background-color: #020202; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      color: white; 
    }
    #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    
    .ui-layer { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      z-index: 2; pointer-events: none; text-align: center; 
    }
    
    #start-screen { 
      background: rgba(0,0,0,0.8); z-index: 10; pointer-events: auto; 
      backdrop-filter: blur(5px); cursor: pointer; transition: opacity 1s ease; 
    }
    .pulse-text { 
      font-size: 1.5rem; letter-spacing: 2px; animation: pulse 2s infinite; color: #ff8eac; 
    }
    
    #story-text { 
      font-size: 2rem; max-width: 80%; text-shadow: 0 0 20px #ff2a6d; 
      opacity: 0; font-weight: 300; font-style: italic; 
    }

    .glass-card { 
      background: rgba(20, 0, 10, 0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
      border: 1px solid rgba(255, 42, 109, 0.3); padding: 30px; border-radius: 20px; 
      box-shadow: 0 0 40px rgba(255, 42, 109, 0.2); pointer-events: auto; 
      display: none; opacity: 0; transform: translateY(20px); max-width: 90%; width: 400px;
      max-height: 85vh; overflow-y: auto; 
    }
    .glass-card::-webkit-scrollbar { display: none; }
    
    .btn { 
      padding: 12px 20px; margin: 5px; font-size: 1rem; font-weight: bold; 
      border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; width: 100%; box-sizing: border-box;
    }
    #btn-yes { background: linear-gradient(45deg, #ff2a6d, #ff7b9c); color: white; box-shadow: 0 0 20px rgba(255,42,109,0.5); width: auto; padding: 12px 30px; margin: 10px;}
    #btn-yes:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(255,42,109,0.8); }
    #btn-no { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); position: relative; width: auto; padding: 12px 30px; margin: 10px;}
    
    textarea { 
      width: 100%; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,42,109,0.4); 
      background: rgba(0,0,0,0.6); color: white; font-family: inherit; resize: none; 
      box-sizing: border-box; margin-top: 10px; margin-bottom: 5px; font-size: 1rem; 
    }
    textarea:focus { outline: none; border-color: #ff2a6d; box-shadow: 0 0 15px rgba(255,42,109,0.3); }
    
    #btn-send { background: linear-gradient(45deg, #00e676, #00b35c); color: white; box-shadow: 0 0 20px rgba(0,230,118,0.4); }
    #btn-record { background: linear-gradient(45deg, #ff9a44, #fc6076); color: white; box-shadow: 0 0 20px rgba(252,96,118,0.4); }
    .recording { animation: blink 1s infinite; background: #ff0000 !important; box-shadow: 0 0 30px red !important; }
    
    .doodle-area { margin-top: 15px; text-align: left; }
    canvas#drawing-pad { border: 2px dashed #ff2a6d; border-radius: 12px; background: rgba(0,0,0,0.5); width: 100%; height: 150px; touch-action: none; cursor: crosshair; }
    .canvas-btns { display: flex; gap: 10px; margin-top: 5px; }

    .camera-area { margin-top: 15px; text-align: left; }
    .video-container { width: 100%; height: 250px; background: rgba(0,0,0,0.5); border: 2px solid #ff2a6d; border-radius: 12px; overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; }
    #camera-stream { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } 
    .camera-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; justify-content: center; }
    #post-take-btns { display: flex; width: 100%; gap: 5px; }

    @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.5; transform: scale(0.95); } }
    @keyframes blink { 50% { opacity: 0.5; } }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
      }
    }
  </script>
</head>
<body>

  <audio id="bgm" src="music.mp3" loop></audio>
  <div id="canvas-container"></div>
  
  <div id="start-screen" class="ui-layer">
    <div class="pulse-text">Ketuk layar untuk mulai...</div>
  </div>

  <div id="story-layer" class="ui-layer">
    <div id="story-text"></div>
  </div>

  <div id="interaction-layer" class="ui-layer">
    <div id="question-box" class="glass-card">
      <h2 style="margin-top:0; color: #ff8eac;">Hai, Kacung...</h2>
      <p style="font-size: 1.2rem; margin-bottom: 30px;">Setelah semua ini, kamu masih sayang banget kan sama aku?</p>
      <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
        <button id="btn-yes" class="btn">Pasti dong! ‚ù§Ô∏è</button>
        <button id="btn-no" class="btn">Enggak üëé</button>
      </div>
    </div>

    <div id="reply-box" class="glass-card">
      <h2 style="margin-top:0; color: #00e676;">Aku juga sayang kamu! üíï</h2>
      
      <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">Kirim pesan atau suara buat aku:</p>
      <textarea id="reply-msg" rows="2" placeholder="Ketik sesuatu dari hati..."></textarea>
      <button id="btn-send" class="btn">Kirim Pesan Teks üíå</button>
      <button id="btn-record" class="btn">üé§ Mulai Rekam Suara</button>
      
      <hr style="border: 1px solid rgba(255,42,109,0.2); margin: 20px 0;">
      
      <div class="doodle-area">
        <p style="font-size: 0.9rem; opacity: 0.8; margin: 0 0 5px 0;">Coret-coret / gambar sesuatu di sini:</p>
        <canvas id="drawing-pad" width="300" height="150"></canvas>
        <div class="canvas-btns">
          <button id="btn-clear-draw" class="btn" style="flex: 1; background: #444; color: white;">Hapus</button>
          <button id="btn-send-draw" class="btn" style="flex: 2; background: linear-gradient(45deg, #9d50bb, #6e48aa); color: white;">Kirim Gambar üé®</button>
        </div>
      </div>

      <hr style="border: 1px solid rgba(255,42,109,0.2); margin: 20px 0;">

      <div class="camera-area">
        <p style="font-size: 0.9rem; opacity: 0.8; margin: 0 0 5px 0;">Kirim selfie dong (Tenang, filternya cakep):</p>
        <div class="video-container">
            <video id="camera-stream" autoplay playsinline></video>
            <canvas id="photo-canvas" style="display:none;"></canvas>
        </div>
        <div class="camera-btns">
          <button id="btn-start-cam" class="btn" style="background: linear-gradient(45deg, #ff00cc, #333399); color: white;">üì∏ Buka Kamera</button>
          <button id="btn-take-photo" class="btn" style="display:none; background: linear-gradient(45deg, #ff2a6d, #ff7b9c); color: white;">Jepret! üí•</button>
          <div id="post-take-btns" style="display:none;">
            <button id="btn-retake" class="btn" style="flex:1; background: #444; color: white;">Ulang</button>
            <button id="btn-send-photo" class="btn" style="flex:2; background: linear-gradient(45deg, #00e676, #00b35c); color: white;">Kirim Foto üì§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    // ==========================================
    // 1. SETUP 3D & EFEK BLOOM
    // ==========================================
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x020202, 0.05);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 15;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ReinhardToneMapping;
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableZoom = false; controls.autoRotate = true; controls.autoRotateSpeed = 1.0;

    scene.add(new THREE.AmbientLight(0x222222));
    const pointLight = new THREE.PointLight(0xff2a6d, 2, 50);
    pointLight.position.set(0, 0, 5);
    scene.add(pointLight);

    // Bikin GRUP khusus untuk Parallax biar gak tabrakan sama OrbitControls
    const sceneGroup = new THREE.Group();
    scene.add(sceneGroup);

    const starsGeo = new THREE.BufferGeometry();
    const starsVert = [];
    for(let i=0; i<4000; i++) {
        starsVert.push(THREE.MathUtils.randFloatSpread(150), THREE.MathUtils.randFloatSpread(150), THREE.MathUtils.randFloatSpread(150));
    }
    starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starsVert, 3));
    const starsMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true, opacity: 0.8 });
    const starField = new THREE.Points(starsGeo, starsMat);
    sceneGroup.add(starField);

    const heartShape = new THREE.Shape();
    const x = 0, y = 0;
    heartShape.moveTo(x + 2.5, y + 2.5);
    heartShape.bezierCurveTo(x + 2.5, y + 2.5, x + 2.0, y, x, y);
    heartShape.bezierCurveTo(x - 3.0, y, x - 3.0, y + 3.5, x - 3.0, y + 3.5);
    heartShape.bezierCurveTo(x - 3.0, y + 5.5, x - 1.0, y + 7.7, x + 2.5, y + 9.5);
    heartShape.bezierCurveTo(x + 6.0, y + 7.7, x + 8.0, y + 5.5, x + 8.0, y + 3.5);
    heartShape.bezierCurveTo(x + 8.0, y + 3.5, x + 8.0, y, x + 5.0, y);
    heartShape.bezierCurveTo(x + 3.5, y, x + 2.5, y + 2.5, x + 2.5, y + 2.5);

    const geometry = new THREE.ExtrudeGeometry(heartShape, { depth: 1.5, bevelEnabled: true, bevelSegments: 4, steps: 2, bevelSize: 0.5, bevelThickness: 0.5 });
    geometry.center();
    const material = new THREE.MeshStandardMaterial({ color: 0xff0040, roughness: 0.1, metalness: 0.5, emissive: 0x440011 });
    const heartMesh = new THREE.Mesh(geometry, material);
    heartMesh.rotation.x = Math.PI;
    heartMesh.scale.set(0, 0, 0); 
    sceneGroup.add(heartMesh);

    const renderScene = new RenderPass(scene, camera);
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.threshold = 0; bloomPass.strength = 1.2; bloomPass.radius = 0.5;

    const composer = new EffectComposer(renderer);
    composer.addPass(renderScene); composer.addPass(bloomPass);

    // ==========================================
    // VARIABEL & FUNGSI GYROSCOPE (PARALLAX)
    // ==========================================
    let gyroX = 0; let gyroY = 0;
    
    // Untuk PC / Mouse
    document.addEventListener('mousemove', (e) => {
      gyroX = (e.clientX / window.innerWidth - 0.5) * 1.5;
      gyroY = (e.clientY / window.innerHeight - 0.5) * 1.5;
    });

    // Untuk Mobile / Sensor HP (Dipanggil saat Tap to Start)
    function setupGyroscope() {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(state => {
          if (state === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation);
          }
        }).catch(console.error);
      } else {
        window.addEventListener('deviceorientation', handleOrientation);
      }
    }

    function handleOrientation(e) {
      let gamma = e.gamma || 0; let beta = e.beta || 0;
      if(gamma > 45) gamma = 45; if(gamma < -45) gamma = -45;
      if(beta > 80) beta = 80; if(beta < 10) beta = 10;
      gyroX = gamma / 45; // Kiri Kanan
      gyroY = (beta - 45) / 35; // Atas Bawah
    }

    // ==========================================
    // LOOP ANIMASI
    // ==========================================
    const clock = new THREE.Clock();
    let heartVisible = false;

    function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        
        // Efek Parallax Halus (Scene Group bergeser mengikuti gyroX/gyroY)
        sceneGroup.rotation.y += (gyroX * 0.5 - sceneGroup.rotation.y) * 0.05;
        sceneGroup.rotation.x += (gyroY * 0.5 - sceneGroup.rotation.x) * 0.05;

        starField.rotation.y += 0.001; 
        if (heartVisible) {
            const pulse = 0.4 + Math.sin(time * 4) * 0.02;
            heartMesh.scale.lerp(new THREE.Vector3(pulse, pulse, pulse), 0.1);
            heartMesh.position.y = Math.sin(time * 2) * 0.4;
        }
        controls.update(); composer.render(); 
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    });

    // ==========================================
    // FITUR RAHASIA (EASTER EGG) - KLIK HATI
    // ==========================================
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let tapCount = 0;

    window.addEventListener('pointerdown', (event) => {
        if(!heartVisible) return;
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        
        // Cek klik pada sceneGroup (karena heartMesh ada di dalam sceneGroup)
        const intersects = raycaster.intersectObject(heartMesh);
        if (intersects.length > 0) {
            tapCount++;
            gsap.to(heartMesh.scale, { x: 0.5, y: 0.5, z: 0.5, duration: 0.1, yoyo: true, repeat: 1 });
            if(tapCount >= 10) { tapCount = 0; explodeHeart(); }
        }
    });

    function explodeHeart() {
        heartVisible = false; heartMesh.scale.set(0,0,0); 
        for(let i=0; i<30; i++) {
            const miniHeart = new THREE.Mesh(geometry, material.clone());
            miniHeart.scale.set(0.05, 0.05, 0.05); miniHeart.rotation.x = Math.PI; sceneGroup.add(miniHeart);
            const angle = Math.random() * Math.PI * 2; const radius = Math.random() * 8 + 2;
            const targetX = Math.cos(angle) * radius; const targetY = Math.sin(angle) * radius + (Math.random()*5); const targetZ = (Math.random() - 0.5) * 8;
            gsap.to(miniHeart.position, { x: targetX, y: targetY, z: targetZ, duration: 1.5, ease: "power3.out" });
            gsap.to(miniHeart.rotation, { x: Math.random()*Math.PI*4, y: Math.random()*Math.PI*4, duration: 1.5 });
            gsap.to(miniHeart.material, { opacity: 0, transparent: true, duration: 1, delay: 1, onComplete: () => sceneGroup.remove(miniHeart) });
        }
        setTimeout(() => { heartVisible = true; gsap.to(heartMesh.scale, { x: 0.4, y: 0.4, z: 0.4, duration: 1, ease: "elastic.out(1, 0.5)" }); }, 2500);
    }

    // ==========================================
    // TELEGRAM API & DATA KAMU
    // ==========================================
    const botToken = "8303109998:AAGOsoAvit6hCAjpSmjBeeCIj2MManPdgWM"; 
    const chatId = "5552266500";

    // ==========================================
    // STORYTELLING & INTERAKSI
    // ==========================================
    const storyLines = [
      "Di antara miliaran manusia di bumi...",
      "Mataku entah kenapa selalu mencarimu.",
      "Mungkin terdengar klise...",
      "Tapi kamu adalah hal terbaik yang pernah terjadi di hidupku."
    ];

    const startScreen = document.getElementById('start-screen');
    const storyText = document.getElementById('story-text');
    const questionBox = document.getElementById('question-box');
    const replyBox = document.getElementById('reply-box');

    startScreen.addEventListener('click', () => {
      startScreen.style.opacity = '0';
      setTimeout(() => startScreen.style.display = 'none', 1000);
      
      setupGyroscope(); // Aktifkan Gyroscope Parallax
      
      const bgm = document.getElementById('bgm');
      bgm.volume = 0; bgm.play().catch(e => console.log("Audio error:", e));
      gsap.to(bgm, { volume: 0.8, duration: 4 }); 

      const tl = gsap.timeline();
      storyLines.forEach((line) => {
        tl.call(() => { storyText.innerText = line; })
          .to(storyText, { opacity: 1, duration: 1.5, ease: "power2.inOut" })
          .to(storyText, { opacity: 0, duration: 1.5, ease: "power2.inOut", delay: 1.5 });
      });
      tl.call(() => {
        heartVisible = true; 
        gsap.to(camera.position, { z: 10, duration: 3, ease: "power3.inOut" });
        questionBox.style.display = 'block';
        gsap.to(questionBox, { opacity: 1, y: 0, duration: 1, ease: "back.out(1.2)", delay: 1 });
      });
    });

    // JEBAKAN TOMBOL "ENGGAK"
    const noBtn = document.getElementById('btn-no');
    const moveBtn = () => {
      const x = (Math.random() - 0.5) * 250; const y = (Math.random() - 0.5) * 250; 
      gsap.to(noBtn, { x: x, y: y, duration: 0.2, ease: "power2.out" });
    };
    noBtn.addEventListener('mouseover', moveBtn); noBtn.addEventListener('touchstart', moveBtn);

    noBtn.addEventListener('click', () => {
      const intelText = `üö® LAPORAN INTEL:\nSi Kacung baru aja berhasil ngeklik tombol "ENGGAK"! Hadeh ngajak ribut nih bos.`;
      fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(intelText)}`);
      gsap.to("body", { backgroundColor: "#8b0000", duration: 0.1, yoyo: true, repeat: 5, onComplete: () => { gsap.to("body", { backgroundColor: "#020202", duration: 0.5 }); }});
      const warning = document.createElement('div');
      warning.innerHTML = "<h1 style='color:#ff2a6d; font-size:3rem; text-shadow:0 0 30px #ff2a6d;'>Hayo... ketahuan mau mencet Enggak! üò°</h1>";
      warning.style.position = 'absolute'; warning.style.top = '30%'; warning.style.width = '100%'; 
      warning.style.textAlign = 'center'; warning.style.zIndex = '9999'; warning.style.pointerEvents = 'none';
      document.body.appendChild(warning);
      gsap.from(warning, {scale: 0, opacity: 0, duration: 0.5, ease: "back.out(2)"});
      gsap.to(warning, {opacity: 0, duration: 0.5, delay: 2.5, onComplete: () => warning.remove()});
      noBtn.style.display = 'none';
    });

    // TOMBOL "IYA"
    document.getElementById('btn-yes').addEventListener('click', () => {
      bloomPass.strength = 2.5; pointLight.color.setHex(0xffffff); heartMesh.material.emissive.setHex(0xff0040);
      gsap.to(starField.scale, { z: 50, duration: 1, yoyo: true, repeat: 1, ease: "power2.inOut" });
      gsap.to(starField.rotation, { y: starField.rotation.y + Math.PI * 2, duration: 2, ease: "power2.inOut" });
      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff2a6d', '#ff7b9c', '#ffffff'], zIndex: 9999 });
      gsap.to(questionBox, { opacity: 0, y: -20, duration: 0.5, onComplete: () => {
        questionBox.style.display = 'none'; replyBox.style.display = 'block';
        gsap.to(replyBox, { opacity: 1, y: 0, duration: 0.8, ease: "back.out(1.5)", delay: 0.5 });
      }});
    });

    // ==========================================
    // KIRIM TEKS, SUARA, DOODLE, & KAMERA
    // ==========================================
    
    document.getElementById('btn-send').addEventListener('click', () => {
      const msg = document.getElementById('reply-msg').value;
      if(msg.trim() === "") return alert("Isi pesannya dulu dong kacung...");
      const btnSend = document.getElementById('btn-send'); btnSend.innerText = "Menerbangkan pesan...";
      const text = `üíå PESAN TEKS DARI KACUNG:\n\n"${msg}"`;
      fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}`)
        .then(res => res.json()).then(data => {
          if(data.ok) { btnSend.innerText = "Teks Terkirim! ‚ù§Ô∏è"; btnSend.style.background = "#ff2a6d"; document.getElementById('reply-msg').disabled = true; } 
          else { alert("Gagal kirim teks."); btnSend.innerText = "Kirim Pesan Teks üíå"; }
        }).catch(err => { alert("Error koneksi."); btnSend.innerText = "Kirim Pesan Teks üíå"; });
    });

    let mediaRecorder; let audioChunks = []; let isRecording = false;
    const btnRecord = document.getElementById('btn-record');
    btnRecord.addEventListener('click', async () => {
      if (!isRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); audioChunks = []; sendVoiceToTelegram(audioBlob);
          };
          mediaRecorder.start(); isRecording = true; btnRecord.innerText = "üõë Hentikan & Kirim Suara"; btnRecord.classList.add('recording');
        } catch (err) { alert("Izinkan akses mikrofon dulu ya di browsernya!"); }
      } else {
        mediaRecorder.stop(); isRecording = false; btnRecord.innerText = "Menerbangkan suara..."; btnRecord.classList.remove('recording');
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
      }
    });
    function sendVoiceToTelegram(audioBlob) {
      const formData = new FormData(); formData.append('chat_id', chatId); formData.append('document', audioBlob, 'Suara_Kacung.webm'); formData.append('caption', 'üé§ Ada pesan suara masuk dari Kacung!');
      fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, { method: 'POST', body: formData })
      .then(res => res.json()).then(data => {
        if(data.ok) { btnRecord.innerText = "üé§ Suara Terkirim! ‚ù§Ô∏è"; btnRecord.style.background = "#ff2a6d"; btnRecord.disabled = true; } 
        else { alert("Gagal mengirim suara."); btnRecord.innerText = "üé§ Coba Rekam Lagi"; }
      }).catch(err => { alert("Koneksi error saat kirim suara."); btnRecord.innerText = "üé§ Coba Rekam Lagi"; });
    }

    const canvas = document.getElementById('drawing-pad'); const ctx = canvas.getContext('2d'); let isDrawing = false;
    ctx.fillStyle = "#1a000a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: (clientX - rect.left) * (canvas.width / rect.width), y: (clientY - rect.top) * (canvas.height / rect.height) };
    }
    function startDraw(e) { isDrawing = true; const pos = getMousePos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); e.preventDefault(); }
    function draw(e) { if (!isDrawing) return; const pos = getMousePos(e); ctx.lineTo(pos.x, pos.y); ctx.strokeStyle = "#ff2a6d"; ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.stroke(); e.preventDefault(); }
    function stopDraw() { isDrawing = false; ctx.closePath(); }
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseleave', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stopDraw);
    document.getElementById('btn-clear-draw').addEventListener('click', () => { ctx.fillStyle = "#1a000a"; ctx.fillRect(0, 0, canvas.width, canvas.height); });
    document.getElementById('btn-send-draw').addEventListener('click', () => {
      const btn = document.getElementById('btn-send-draw'); btn.innerText = "Mengirim...";
      canvas.toBlob((blob) => {
        const formData = new FormData(); formData.append('chat_id', chatId); formData.append('photo', blob, 'doodle.png'); formData.append('caption', 'üé® Coretan spesial dari Kacung!');
        fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: 'POST', body: formData })
        .then(res => res.json()).then(data => { if(data.ok) { btn.innerText = "Gambar Terkirim! üé®"; btn.style.background = "#ff2a6d"; btn.disabled = true; } else { alert("Gagal kirim gambar."); btn.innerText = "Kirim Gambar üé®"; }})
        .catch(err => { alert("Error koneksi saat kirim gambar."); btn.innerText = "Kirim Gambar üé®"; });
      }, 'image/png');
    });

    const videoEl = document.getElementById('camera-stream');
    const photoCanvas = document.getElementById('photo-canvas'); const photoCtx = photoCanvas.getContext('2d'); let streamObj = null;
    
    document.getElementById('btn-start-cam').addEventListener('click', async () => {
      try {
        streamObj = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        videoEl.srcObject = streamObj;
        document.getElementById('btn-start-cam').style.display = 'none'; document.getElementById('btn-take-photo').style.display = 'inline-block';
      } catch (err) { alert("Gagal akses kamera. Izinkan dulu ya!"); }
    });

    document.getElementById('btn-take-photo').addEventListener('click', () => {
      photoCanvas.width = videoEl.videoWidth; photoCanvas.height = videoEl.videoHeight;
      photoCtx.translate(photoCanvas.width, 0); photoCtx.scale(-1, 1); 
      photoCtx.drawImage(videoEl, 0, 0, photoCanvas.width, photoCanvas.height);
      videoEl.pause();
      document.getElementById('btn-take-photo').style.display = 'none'; document.getElementById('post-take-btns').style.display = 'flex';
    });

    document.getElementById('btn-retake').addEventListener('click', () => {
      videoEl.play();
      document.getElementById('post-take-btns').style.display = 'none'; document.getElementById('btn-take-photo').style.display = 'inline-block';
    });

    document.getElementById('btn-send-photo').addEventListener('click', () => {
      const btn = document.getElementById('btn-send-photo'); btn.innerText = "Mengirim...";
      photoCanvas.toBlob((blob) => {
        const formData = new FormData(); formData.append('chat_id', chatId); formData.append('photo', blob, 'selfie.png'); formData.append('caption', 'üì∏ Kacung ngirim pap selfie nih!');
        fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
          if(data.ok) { 
            btn.innerText = "Foto Terkirim! üì∏"; btn.style.background = "#ff2a6d"; btn.disabled = true; document.getElementById('btn-retake').style.display = 'none';
            if(streamObj) streamObj.getTracks().forEach(track => track.stop());
          } else { alert("Gagal kirim foto."); btn.innerText = "Kirim Foto üì§"; }
        }).catch(err => { alert("Error koneksi saat kirim foto."); btn.innerText = "Kirim Foto üì§"; });
      }, 'image/png');
    });

  </script>
</body>
</html>
